plugins {
    id 'java'
    id 'application'
}

group = 'de.bund.zrb'
version = '2.0.0'

sourceCompatibility = 1.8

application {
    // Define main class for runnable JAR
    mainClassName = 'de.bund.zrb.Main'
}

repositories {
    mavenCentral()
}

// Separate configuration for optional video dependencies
configurations {
    videoRuntime
}

dependencies {
    // Core dependencies (always shipped in libs/)
    implementation 'com.google.code.gson:gson:2.10.1'

    // TODO: Add further core modules here as needed (e.g. :core, logging, etc.)
    // implementation project(':core')

    // Video-specific dependencies (optional, only for video-enabled distribution)
    // Use Windows x86_64 natives only
    videoRuntime 'org.bytedeco:ffmpeg:6.1.1-1.5.10'
    videoRuntime 'org.bytedeco:ffmpeg:6.1.1-1.5.10:windows-x86_64'
    videoRuntime 'org.bytedeco:opencv:4.9.0-1.5.10'
    videoRuntime 'org.bytedeco:opencv:4.9.0-1.5.10:windows-x86_64'
}

// Copy core runtime classpath jars into dist/libs
task copyRuntimeLibsCore(type: Copy) {
    from configurations.runtimeClasspath
    into '$buildDir/dist/libs'
}

// Copy optional video jars into dist/libs-video (Windows-only)
task copyVideoLibs(type: Copy) {
    from configurations.videoRuntime
    into '$buildDir/dist/libs-video'
}

jar {
    doFirst {
        // Build Class-Path entries for core and optional video libs
        def coreJars = configurations.runtimeClasspath.files.collect { 'libs/' + it.name }
        def videoJars = configurations.videoRuntime.files.collect { 'libs-video/' + it.name }

        manifest {
            attributes(
                    'Main-Class': application.mainClassName,
                    'Class-Path': (coreJars + videoJars).join(' ')
            )
        }
    }
}

// Assemble distribution layout under build/dist
// - app.jar (runnable)
// - libs/ (core)
// - libs-video/ (optional video stack, Windows-only)
task assembleDist(type: Copy) {
    dependsOn jar, copyRuntimeLibsCore, copyVideoLibs

    from('$buildDir/libs/' + project.name + '-' + version + '.jar') {
        rename { 'app.jar' }
    }

    from('$buildDir/dist/libs') {
        into 'libs'
    }

    from('$buildDir/dist/libs-video') {
        into 'libs-video'
    }

    into '$buildDir/dist'
}

build.dependsOn assembleDist
