plugins {
    id 'java'
    id 'application'
}

group = 'de.bund.zrb'
version = '2.0.0'

sourceCompatibility = 1.8

application {
    // Gradle 8+ API
    mainClass = 'de.bund.zrb.Main'
}

// Property-Schalter für optionale Video-Libs (Default: false)
def includeVideo = project.hasProperty('includeVideo') && project.property('includeVideo') == 'true'

configurations { videoRuntime }

dependencies {
    implementation project(':wd4j')
    implementation project(':playwright-adapter')
    implementation project(':playwright-java')

    implementation 'org.slf4j:slf4j-api:1.7.36'
    implementation 'ch.qos.logback:logback-classic:1.2.11'

    implementation 'org.java-websocket:Java-WebSocket:1.5.2'
    implementation 'org.apache.httpcomponents.client5:httpclient5:5.4.1'
    implementation 'com.google.code.gson:gson:2.10.1'
    implementation 'org.reflections:reflections:0.10.2'

    implementation 'org.apache.pdfbox:pdfbox:2.0.27'

    implementation 'com.fifesoft:rsyntaxtextarea:3.3.3'
    implementation 'com.fifesoft:autocomplete:3.3.1'

    implementation 'org.graalvm.js:js:22.3.0'

    implementation 'com.warrenstrange:googleauth:1.4.0'

    implementation 'net.java.dev.jna:jna:5.13.0'
    implementation 'net.java.dev.jna:jna-platform:5.13.0'

    implementation 'com.google.googlejavaformat:google-java-format:1.7'

    // Optional Video / Natives (nur laden wenn includeVideo gesetzt)
    videoRuntime 'org.bytedeco:javacv-platform:1.5.10'
    videoRuntime 'org.bytedeco:ffmpeg:6.1.1-1.5.10:windows-x86_64'
}

// Core Lib Kopie
task copyRuntimeLibsCore(type: Copy) {
    from configurations.runtimeClasspath
    into "$buildDir/dist/libs"
}

def selectWinVideoFiles(Set<File> files) {
    files.findAll { File f ->
        def n = f.name
        // Behalte nur: javacv-*.jar, javacpp-*.jar (base oder windows), ffmpeg-*-windows-*.jar
        (n.startsWith('javacv-') && n.endsWith('.jar')) ||
        (n.startsWith('javacpp-') && n.endsWith('.jar') && (n.contains('windows-') || !(n.contains('-android-') || n.contains('-linux') || n.contains('-macosx') || n.contains('-ios')))) ||
        (n.startsWith('ffmpeg-') && n.contains('windows-') && n.endsWith('.jar'))
    }
}

// Video Lib Kopie (nur wenn eingeschaltet)
task copyVideoLibs(type: Copy) {
    onlyIf { includeVideo }
    from {
        def files = configurations.videoRuntime.files
        selectWinVideoFiles(files)
    }
    into "$buildDir/dist/libs-video"
}

jar {
    doFirst {
        def coreJars = configurations.runtimeClasspath.files.collect { 'libs/' + it.name }
        def videoJars = []
        if (includeVideo) {
            def selected = selectWinVideoFiles(configurations.videoRuntime.files)
            videoJars = selected.collect { 'libs-video/' + it.name }
        }
        manifest {
            attributes(
                'Main-Class': application.mainClass.get(),
                'Class-Path': (coreJars + videoJars).join(' ')
            )
        }
    }
}

// Minimale Distribution (ohne Video) – verwendet includeVideo=false
task assembleDistMinimal(type: Copy) {
    // Explizit sicherstellen
    dependsOn jar, copyRuntimeLibsCore
    from("$buildDir/libs/${project.name}-${version}.jar") { rename { 'app.jar' } }
    from("$buildDir/dist/libs") { into 'libs' }
    // Kein libs-video
    into "$buildDir/dist/minimal"
}

// Volle Distribution (mit Video) – benötigt -PincludeVideo=true
task assembleDistFull(type: Copy) {
    dependsOn jar, copyRuntimeLibsCore, copyVideoLibs
    from("$buildDir/libs/${project.name}-${version}.jar") { rename { 'app.jar' } }
    from("$buildDir/dist/libs") { into 'libs' }
    from("$buildDir/dist/libs-video") { into 'libs-video' }
    into "$buildDir/dist/full"
}

// Legacy assembleDist (kompatibel, verweist je nach Flag auf passend)
if (tasks.findByName('assembleDist') == null) {
    task assembleDist {
        dependsOn(includeVideo ? 'assembleDistFull' : 'assembleDistMinimal')
    }
}

// build hängt an assembleDist (bleibt gleich)
build.dependsOn 'assembleDist'
